<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bathroom Code Finder</title>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
<!-- Include the Places library -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDm25uh1YtFQb01225StIWKP8VWCMR_NHk&callback=initMap&libraries=places,geometry&v=weekly" async></script>

<style>
    #map {
        height: 80vh;
        width: 100%;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgb(0,0,0);
        background-color: rgba(0,0,0,0.4);
        padding-top: 60px;
    }
    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
    }
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }
    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
</style>
</head>
<body>
<h1>Bathroom Code Finder</h1>
<div id="map"></div>

<!-- The Modal -->
<div id="myModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
		<center>
        <p id="modalText">Please enter the bathroom code:</p>
        <input type="text" id="bathroomCodeInput" placeholder="Enter bathroom code">
		<br><br>
        <button onclick="submitCode()">Submit</button>
    </div>
</div>

<!-- Report Code Modal -->
<div id="reportModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
		<center>
        <p id="reportModalText">Report a new code for this location:</p>
        <input type="text" id="newCodeInput" placeholder="Enter new bathroom code">
		<br><br>
        <button onclick="submitNewCode()">Report New Code</button>
    </div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyDMJlfraZTCNDlit1dgJ4Z1MbLdLgGG1V8",
    authDomain: "cluster-825c6.firebaseapp.com",
    databaseURL: "https://cluster-825c6-default-rtdb.firebaseio.com",
    projectId: "cluster-825c6",
    storageBucket: "cluster-825c6.appspot.com",
    messagingSenderId: "274663865161",
    appId: "1:274663865161:web:f8ff687b71efbe2b557898",
    measurementId: "G-KCM0ZSB341"
};

const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let selectedLocation = null;

function initMap() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            const map = new google.maps.Map(document.getElementById("map"), {
                center: userLocation,
                zoom: 16,
            });
            attachMapListeners(map);
        }, function() {
            handleLocationError(true, map);
        });
    } else {
        handleLocationError(false, null);
    }
}

function attachMapListeners(map) {
    const service = new google.maps.places.PlacesService(map);
    map.addListener("click", function(event) {
        nearbySearch(service, event.latLng);
    });
    loadExistingCodes(map);
}

function nearbySearch(service, location) {
    const request = {
        location: location,
        radius: '50',
    };

    service.nearbySearch(request, function(results, status) {
        if (status === google.maps.places.PlacesServiceStatus.OK && results.length > 0) {
            results.sort((a, b) => {
                let distA = google.maps.geometry.spherical.computeDistanceBetween(location, a.geometry.location);
                let distB = google.maps.geometry.spherical.computeDistanceBetween(location, b.geometry.location);
                return distA - distB;
            });

            let closestPlace = results[0];
            if (closestPlace) {
                showModal(closestPlace.name);
                selectedLocation = location;
            } else {
                showModal("Specific location details unavailable");
            }
        } else {
            showModal("No places found nearby");
        }
    });
}

function showModal(locationName = "Location details not available") {
    var modalText = document.getElementById("modalText");
    modalText.textContent = `You're the first person to poop at ${locationName}. Congrats`;
    var modal = document.getElementById("myModal");
    modal.style.display = "block";

    document.getElementsByClassName("close")[0].onclick = function() {
        modal.style.display = "none";
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
}

function loadExistingCodes(map) {
    db.collection("bathroomCodes").get().then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
            const data = doc.data();
            const marker = new google.maps.Marker({
                position: { lat: data.lat, lng: data.lng },
                map: map,
                title: "Bathroom Code"
            });

            marker.addListener("click", function() {
                showReportModal(data.code);
            });
        });
    });
}

function showReportModal(code) {
    var reportModalText = document.getElementById("reportModalText");
    reportModalText.textContent = `The bathroom code is ${code}`;
    var reportModal = document.getElementById("reportModal");
    reportModal.style.display = "block";

    document.getElementsByClassName("close")[1].onclick = function() {
        reportModal.style.display = "none";
    }

    window.onclick = function(event) {
        if (event.target == reportModal) {
            reportModal.style.display = "none";
        }
    }
}

function handleLocationError(hasGeoLocation, map) {
    var pos = map ? map.getCenter() : { lat: 37.0902, lng: -95.7129 };
    map = new google.maps.Map(document.getElementById("map"), {
        center: pos,
        zoom: 4,
    });
    attachMapListeners(map);
    alert(hasGeoLocation ?
        'Error: The Geolocation service failed.' :
        'Error: Your browser doesn\'t support geolocation.');
}

function submitCode() {
    const code = document.getElementById("bathroomCodeInput").value;
    if (code && selectedLocation) {
        db.collection("bathroomCodes").add({
            lat: selectedLocation.lat(),
            lng: selectedLocation.lng(),
            code: code
        }).then(() => {
            alert("Code submitted successfully!");
            document.getElementById("myModal").style.display = "none";
            location.reload();
        }).catch((error) => {
            console.error("Error adding document: ", error);
        });
    } else {
        alert("Please enter a code!");
    }
}

function submitNewCode() {
    const newCode = document.getElementById("newCodeInput").value;
    if (newCode && selectedLocation) {
        db.collection("bathroomCodes").where("lat", "==", selectedLocation.lat())
        .where("lng", "==", selectedLocation.lng())
        .get()
        .then(querySnapshot => {
            querySnapshot.forEach(doc => {
                db.collection("bathroomCodes").doc(doc.id).update({
                    code: newCode
                }).then(() => {
                    alert("New code submitted successfully!");
                    document.getElementById("reportModal").style.display = "none";
                    location.reload();
                }).catch((error) => {
                    console.error("Error updating document: ", error);
                });
            });
        });
    } else {
        alert("Please enter a new code!");
    }
}
</script>
</body>
</html>
